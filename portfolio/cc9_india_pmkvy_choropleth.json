{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "India (district-level geometry) choropleth colored by State/UT PMKVY values. Year selector + metric selector.",
  "width": "container",
  "height": 520,

  "data": {
    "url": "https://raw.githubusercontent.com/EconomicsObservatory/courses/main/datasets/advanced/india_districts.topojson",
    "format": { "type": "topojson", "feature": "india-districts-727" }
  },

  "params": [
    {
      "name": "yearSel",
      "value": "FY-20-21",
      "bind": {
        "input": "select",
        "options": ["FY-20-21", "FY-21-22", "FY-22-23", "FY-23-24", "FY-24-25"],
        "name": "Year: "
      }
    },
    {
      "name": "metricSel",
      "value": "skilled",
      "bind": {
        "input": "radio",
        "options": ["skilled", "placed", "placement_rate"],
        "name": "Metric: "
      }
    }
  ],

  "transform": [
    {
      "calculate": "coalesce(datum.properties.st_nm, datum.properties.ST_NM, datum.properties.state, datum.properties.STATE, datum.properties.NAME_1, datum.properties.NAME)",
      "as": "state_raw"
    },
    {
      "calculate": "replace(lower(datum.state_raw), /[^a-z]/g, '')",
      "as": "state_key"
    },
    {
      "lookup": "state_key",
      "from": {
        "data": { "url": "cc9_pmkvy_tidy.json" },
        "key": "state_key",
        "fields": ["state", "fy", "skilled", "placed", "placement_rate"]
      }
    },
    { "filter": "datum.fy == yearSel" },
    {
      "calculate": "metricSel == 'skilled' ? datum.skilled : (metricSel == 'placed' ? datum.placed : datum.placement_rate)",
      "as": "value"
    }
  ],

  "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.2 },

  "encoding": {
    "color": { "field": "value", "type": "quantitative", "title": null },
    "tooltip": [
      { "field": "state_raw", "type": "nominal", "title": "State (map)" },
      { "field": "state", "type": "nominal", "title": "Matched state" },
      { "field": "fy", "type": "nominal", "title": "Year" },
      { "field": "skilled", "type": "quantitative", "format": "," },
      { "field": "placed", "type": "quantitative", "format": "," },
      { "field": "placement_rate", "type": "quantitative", "format": ".1%" }
    ]
  }
}