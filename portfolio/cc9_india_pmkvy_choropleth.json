{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "India choropleth (district geometry, state-colored) for PMKVY. Year dropdown + metric selector.",
  "width": "container",
  "height": 520,

  "data": {
    "url": "https://raw.githubusercontent.com/EconomicsObservatory/courses/main/datasets/advanced/india_districts.topojson",
    "format": { "type": "topojson", "feature": "india-districts-727" }
  },

  "params": [
    {
      "name": "yearSel",
      "value": "FY-20-21",
      "bind": {
        "input": "select",
        "options": ["FY-20-21", "FY-21-22", "FY-22-23", "FY-23-24", "FY-24-25"],
        "name": "Year: "
      }
    },
    {
      "name": "metricSel",
      "value": "skilled",
      "bind": {
        "input": "radio",
        "options": ["skilled", "placed", "placement_rate"],
        "name": "Metric: "
      }
    }
  ],

  "transform": [
    {
  "calculate": "datum.properties && datum.properties.st_nm ? datum.properties.st_nm : (datum.properties && datum.properties.ST_NM ? datum.properties.ST_NM : (datum.properties && datum.properties.state ? datum.properties.state : (datum.properties && datum.properties.STATE ? datum.properties.STATE : (datum.properties && datum.properties.NAME_1 ? datum.properties.NAME_1 : (datum.properties && datum.properties.NAME ? datum.properties.NAME : null)))))",
  "as": "state_raw"
},
    {
      "calculate": "replace(lower(datum.state_raw), /[^a-z]/g, '')",
      "as": "state_key"
    },
    {
      "lookup": "state_key",
      "from": {
        "data": { "url": "cc9_pmkvy_state_wide.json" },
        "key": "state_key",
        "fields": [
          "state",
          "skilled_FY-20-21","skilled_FY-21-22","skilled_FY-22-23","skilled_FY-23-24","skilled_FY-24-25",
          "placed_FY-20-21","placed_FY-21-22","placed_FY-22-23","placed_FY-23-24","placed_FY-24-25",
          "placement_rate_FY-20-21","placement_rate_FY-21-22","placement_rate_FY-22-23","placement_rate_FY-23-24","placement_rate_FY-24-25"
        ]
      }
    },
    {
      "calculate": "metricSel + '_' + yearSel",
      "as": "colname"
    },
    {
      "calculate": "datum[datum.colname]",
      "as": "value"
    }
  ],

  "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.2 },

  "encoding": {
    "color": { "field": "value", "type": "quantitative", "title": null },
    "tooltip": [
      { "field": "state_raw", "type": "nominal", "title": "State (map)" },
      { "field": "state", "type": "nominal", "title": "Matched state" },
      { "field": "value", "type": "quantitative", "title": "Selected metric", "format": ",.2f" }
    ]
  }
}